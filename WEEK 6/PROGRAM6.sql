SHOW DATABASES;
USE COMPANY;
CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);
CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGRNO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO)
);



INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Hyderabad'),
(30, 'Development', 'Mysuru'),
(40, 'Marketing', 'Delhi'),
(50, 'Support', 'Bengaluru');
SELECT * FROM DEPT;

INSERT INTO EMPLOYEE VALUES
(101, 'Rahul', 101, '2020-01-10', 50000, 10),
(102, 'Priya', 101, '2019-03-12', 60000, 20),
(103, 'Anil', 102, '2021-06-01', 55000, 30),
(104, 'Divya', 101, '2022-07-21', 52000, 10),
(105, 'Vikram', 103, '2023-01-15', 58000, 40),
(106, 'Kiran', 102, '2020-12-10', 51000, 50);
SELECT * FROM EMPLOYEE;

INSERT INTO PROJECT VALUES
(1001, 'ERP System', 'Bengaluru'),
(1002, 'Payroll App', 'Hyderabad'),
(1003, 'E-commerce Site', 'Mysuru'),
(1004, 'CRM Portal', 'Delhi'),
(1005, 'Cloud Migration', 'Bengaluru');
SELECT * FROM PROJECT;

INSERT INTO ASSIGNED_TO VALUES
(101, 1001, 'Manager'),
(102, 1002, 'Analyst'),
(103, 1003, 'Developer'),
(104, 1001, 'Tester'),
(105, 1004, 'Executive'),
(106, 1005, 'Support');

SELECT * FROM ASSIGNED_TO;

INSERT INTO INCENTIVES VALUES
(101, '2019-01-10', 4000),
(102, '2019-01-12', 2500),
(103, '2019-01-15', 3500),
(104, '2019-01-20', 3000),
(105, '2019-01-25', 4500);

SELECT * FROM INCENTIVES;

SELECT DISTINCT A.EMPNO
FROM ASSIGNED_TO A
JOIN PROJECT P ON A.PNO = P.PNO
WHERE P.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');

SELECT EMPNO
FROM EMPLOYEE
WHERE EMPNO NOT IN (SELECT EMPNO FROM INCENTIVES);

SELECT 
    E.ENAME,
    E.EMPNO,
    D.DNAME AS DEPARTMENT,
    A.JOB_ROLE,
    D.DLOC AS DEPT_LOCATION,
    P.PLOC AS PROJECT_LOCATION
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE D.DLOC = P.PLOC;

SELECT E.EName AS Manager_Name
FROM Employee E
JOIN Employee M ON E.Empno = M.Mgrno
GROUP BY E.EName
HAVING COUNT(M.Empno) = (
    SELECT MAX(Cnt)
    FROM (
        SELECT COUNT(Mgrno) AS Cnt
        FROM Employee
        WHERE Mgrno IS NOT NULL
        GROUP BY Mgrno
    ) AS T
);

SELECT E.ename
FROM Employee E
JOIN Employee M ON E.empno = M.mgrno
GROUP BY E.empno, E.sal, E.ename
HAVING E.sal > AVG(M.sal);

SELECT E.ENAME AS Second_Level_Manager, D.DNAME AS Department
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGRNO = M.EMPNO
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE M.MGRNO IS NULL;

SELECT E.*
FROM EMPLOYEE E
JOIN INCENTIVES I ON E.EMPNO = I.EMPNO
WHERE I.INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
AND I.INCENTIVE_AMOUNT = (
    SELECT MAX(INCENTIVE_AMOUNT)
    FROM INCENTIVES
    WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
      AND INCENTIVE_AMOUNT < (
          SELECT MAX(INCENTIVE_AMOUNT)
          FROM INCENTIVES
          WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
      )
);


SELECT E.ENAME,M.ENAME AS MANAGER FROM EMPLOYEE E JOIN EMPLOYEE M ON E.MGRNO=M.EMPNO WHERE E.DEPTNO=M.DEPTNO;
